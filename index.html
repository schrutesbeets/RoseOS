<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>RoseOS</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* 
           RoseOS Design System 
           Focus: High Contrast, AAA Accessibility, Native Scaling
        */

        :root {
            /* System Colors for Auto Dark/Light Mode + High Contrast */
            /* Using modern CSS System Colors */
            --bg-color: Canvas;
            --text-color: CanvasText;
            --link-color: LinkText;

            /* Dimensions */
            --btn-min-height: 70px;
            --border-width: 2px;
            --gap-size: 0.75rem;

            /* Typography */
            --font-base: 1.5rem;
            --font-lg: 2rem;
            --font-xl: 2.5rem;

            /* Misc */
            --radius: 4px;
            /* Slight round, but stark */
        }

        /* 
           Force high contrast overrides if system colors fail or for specific aesthetic 
           Using a media query specific approach for more control if needed 
        */
        @media (prefers-color-scheme: dark) {
            :root {
                /* System colors usually handle this, but enforcing high contrast feel */
                --bg-color: #000000;
                --text-color: #FFFFFF;
                --bg-image: url('assets/rose-os-dm@1x.jpg');
                --bg-image-set: -webkit-image-set(url('assets/rose-os-dm@1x.jpg') 1x,
                        url('assets/rose-os-dm@2x.jpg') 2x,
                        url('assets/rose-os-dm@3x.jpg') 3x);
                --bg-image-set-std: image-set(url('assets/rose-os-dm@1x.jpg') 1x,
                        url('assets/rose-os-dm@2x.jpg') 2x,
                        url('assets/rose-os-dm@3x.jpg') 3x);
            }
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg-color: #FFFFFF;
                --text-color: #000000;
                --bg-image: url('assets/rose-os-lm@1x.jpg');
                --bg-image-set: -webkit-image-set(url('assets/rose-os-lm@1x.jpg') 1x,
                        url('assets/rose-os-lm@2x.jpg') 2x,
                        url('assets/rose-os-lm@3x.jpg') 3x);
                --bg-image-set-std: image-set(url('assets/rose-os-lm@1x.jpg') 1x,
                        url('assets/rose-os-lm@2x.jpg') 2x,
                        url('assets/rose-os-lm@3x.jpg') 3x);
            }
        }

        /* 
           High Contrast Mode Override
        */
        @media (prefers-contrast: more) {
            :root {
                --border-width: 4px;
                /* Thicker borders */
            }
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Roboto', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overscroll-behavior-y: none;
            /* Prevent bounce */
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-image: var(--bg-image);
            background-image: var(--bg-image-set);
            background-image: var(--bg-image-set-std);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            pointer-events: none;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0.25rem 0 0.5rem 0;
        }

        h1 {
            font-size: var(--font-xl);
            margin: 0;
            text-align: left;
            font-weight: 800;
            line-height: 1.1;
        }

        .settings-icon-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .settings-icon-btn:active {
            background-color: var(--text-color);
            color: var(--bg-color);
        }

        .settings-icon-btn svg {
            width: 2.5rem;
            height: 2.5rem;
            fill: currentColor;
        }

        h2 {
            font-size: var(--font-lg);
            margin: 0 0 1rem 0;
        }

        /* The Main Stack */
        main {
            display: flex;
            flex-direction: column;
            flex: 1;
            /* gap: var(--gap-size);  Removed to use space-between below widget */
        }

        .launcher-actions {
            display: flex;
            flex-direction: column;
            flex: 1;
            justify-content: space-between;
            padding-bottom: 0.5rem;
        }

        /* Rose Rules: Action Buttons */
        .rose-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: var(--btn-min-height);
            background: var(--bg-color);
            color: var(--text-color);
            border: var(--border-width) solid var(--text-color);
            border-radius: var(--radius);
            font-size: var(--font-base);
            font-weight: 700;
            text-decoration: none;
            cursor: pointer;
            box-shadow: none;
            /* Strict Rule: No soft shadows */
            padding: 1rem;
            text-align: center;
            /* Enhance touch target */
            touch-action: manipulation;
            transition: transform 0.1s;
        }

        .rose-btn:active,
        .rose-btn.active {
            background-color: var(--text-color);
            color: var(--bg-color);
            transform: scale(0.98);
        }

        .rose-btn.secondary {
            font-size: 1.25rem;
            min-height: 60px;
        }

        /* Inputs */
        .rose-input {
            width: 100%;
            font-size: var(--font-base);
            padding: 1rem;
            border: var(--border-width) solid var(--text-color);
            background: var(--bg-color);
            color: var(--text-color);
            margin-bottom: 1rem;
            border-radius: var(--radius);
        }

        .rose-input:focus {
            outline: 3px solid var(--text-color);
            outline-offset: 4px;
        }

        .rose-input::placeholder {
            font-size: 2rem;
            opacity: 0.5;
        }

        /* Search Layout */
        .search-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* Dialog/Modal Styling */
        dialog {
            width: 90vw;
            max-width: 600px;
            background: var(--bg-color);
            color: var(--text-color);
            border: var(--border-width) solid var(--text-color);
            border-radius: var(--radius);
            padding: 1.5rem;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.8);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-color);
            cursor: pointer;
            padding: 0 0.5rem;
        }

        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 50vh;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        /* Settings Area */
        .settings-link {
            margin-top: 2rem;
            text-align: center;
        }

        .settings-link button {
            background: none;
            border: none;
            text-decoration: underline;
            font-size: 1.25rem;
            color: var(--text-color);
            padding: 1rem;
            cursor: pointer;
        }

        /* Helper Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        /* Weather Widget */
        .weather-widget {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: transparent;
            border: none;
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.5rem;
            margin-top: 0.25rem;
        }

        .weather-left-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .weather-temp {
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -1px;
        }

        .weather-details-col {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }

        .weather-location {
            font-size: 1.1rem;
            font-weight: 600;
            opacity: 0.9;
        }

        .weather-range {
            font-size: 1rem;
            font-weight: 500;
            opacity: 0.7;
            display: flex;
            gap: 0.75rem;
        }

        .weather-desc {
            font-size: 1rem;
            font-weight: 500;
            opacity: 0.7;
            text-transform: capitalize;
        }

        .weather-icon svg {
            width: 3.5rem;
            height: 3.5rem;
            fill: currentColor;
        }
    </style>
</head>

<body>

    <header>
        <h1 id="app-title" style="user-select: none; -webkit-user-select: none;">Hello, Rose</h1>
        <button class="settings-icon-btn" onclick="window.location.reload(true)" aria-label="Refresh">
            <svg viewBox="0 0 24 24">
                <path
                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
            </svg>
        </button>
    </header>

    <main id="launcher">
        <!-- Weather Widget -->
        <div id="weather-widget" class="weather-widget" onclick="initWeather()" style="display: none;">
            <div class="weather-left-group">
                <div class="weather-temp" id="weather-temp">--°</div>
                <div class="weather-icon" id="weather-icon">
                    <!-- Default loading icon/placeholder -->
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-5.5l6-4.5-6-4.5v9z" />
                    </svg>
                </div>
                <div class="weather-details-col">
                    <div class="weather-location" id="weather-location">Locating...</div>
                    <div class="weather-range" id="weather-range">
                        <!-- Populated by JS -->
                    </div>
                    <div class="weather-desc" id="weather-desc">loading</div>
                </div>
            </div>
        </div>

        <div class="launcher-actions">
            <!-- Call -->
            <button class="rose-btn" onclick="openCallModal()">
                CALL SOMEONE
            </button>

            <!-- Text -->
            <button class="rose-btn" onclick="window.location.href = 'shortcuts://run-shortcut?name=New%20Message'">
                SEND TEXT
            </button>

            <!-- Add Contact -->
            <button class="rose-btn" onclick="openAddContact()">
                ADD CONTACT
            </button>

            <!-- Email -->
            <button class="rose-btn" onclick="handleAol()">
                CHECK EMAIL ON AOL
            </button>

            <!-- Search -->
            <button class="rose-btn" onclick="handleSearch()">
                GOOGLE SEARCH
            </button>

            <!-- Photos -->
            <button class="rose-btn" onclick="openPhotosLibrary()">
                MY PHOTOS
            </button>

            <div class="text-center" style="opacity: 0.6; font-size: 1rem;">
                Version 2.5
            </div>
        </div>
    </main>

    <!-- CALL OPTIONS MODAL -->
    <dialog id="callOptionsModal">
        <div class="modal-header">
            <h2>Call Someone</h2>
            <button class="close-btn" onclick="closeCallOptions()">✕</button>
        </div>

        <button class="rose-btn" onclick="openDialerFromOptions()" style="margin-bottom: 1rem;">
            SHOW DIALPAD
        </button>

        <button class="rose-btn" onclick="window.location.href = 'shortcuts://run-shortcut?name=Call%20Contact'">
            SELECT CONTACT
        </button>
    </dialog>



    <!-- DIALER MODAL -->
    <dialog id="dialerModal">
        <div class="modal-header">
            <h2>Dial Number</h2>
            <button class="close-btn" onclick="closeDialerModal()">✕</button>
        </div>

        <input type="tel" id="manualPhoneInput" class="rose-input" style="font-size: 2.5rem; letter-spacing: 2px;"
            placeholder="000-000-0000">

        <button class="rose-btn" onclick="handleManualCall()">
            CALL NOW
        </button>
    </dialog>

    <!-- SYSTEM SETTINGS MODAL -->
    <dialog id="systemSettingsModal" class="hidden">
        <!-- Removed - but keeping placeholder structure if ever needed -->
    </dialog>

    <!-- SECRET README MODAL -->
    <dialog id="readmeModal">
        <div class="modal-header">
            <h2>System Guide</h2>
            <button class="close-btn" onclick="document.getElementById('readmeModal').close()">✕</button>
        </div>
        <div style="font-size: 1.1rem; line-height: 1.4; max-height: 60vh; overflow-y: auto;">
            <p><strong>Device Requirements</strong></p>
            <p>iOS (iPhone) recommended. Add to Home Screen via Safari Share menu.</p>

            <p><strong>Required Shortcuts</strong></p>
            <p>Create these in the Shortcuts app (Exact Names):</p>
            <ul>
                <li><strong>"Call Contact"</strong>: 1. Select Contact, 2. Call (Recipient = Selected Contact)</li>
                <li><strong>"New Message"</strong>: 1. Select Contact, 2. Send Message (Recipient = Selected Contact)
                </li>
                <li><strong>"Recent Photos"</strong>: Action - Open App (Photos)</li>
            </ul>

            <p><strong>Other</strong></p>
            <ul>
                <li>Google Search: Opens in Chrome if detected.</li>
                <li>AOL Mail: Redirects to web mail.</li>
            </ul>
        </div>
    </dialog>

    <!-- ADD CONTACT MODAL (Formerly Settings Modal) -->
    <dialog id="settingsModal">
        <div class="modal-header">
            <h2>Add Contact</h2>
            <button class="close-btn" onclick="closeAddContact()">✕</button>
        </div>

        <form onsubmit="saveContact(event)">
            <label for="newName"
                style="font-size: 1.5rem; font-weight: bold; display:block; margin-bottom:0.5rem;">Name</label>
            <input type="text" id="newName" class="rose-input" required placeholder="e.g. John">

            <label for="newPhone"
                style="font-size: 1.5rem; font-weight: bold; display:block; margin-bottom:0.5rem;">Number</label>
            <input type="tel" id="newPhone" class="rose-input" required placeholder="e.g. 555-1234">

            <button type="submit" class="rose-btn">
                SAVE CONTACT
            </button>
        </form>

        <p style="font-size: 1rem; margin-top: 1rem;">
            *Saving will download a contact card. Please tap it to add to your phone's address book.
        </p>
    </dialog>

    <!-- SETUP WIZARD MODAL -->
    <dialog id="setupWizardModal">
        <div class="modal-header">
            <h2>Welcome to RoseOS</h2>
        </div>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">To get started, please install the required Shortcuts.
            </p>

            <a href="./assets/shortcuts/Call%20Contact.shortcut" download class="rose-btn">
                Download Call Contact
            </a>
            <a href="./assets/shortcuts/New%20Message.shortcut" download class="rose-btn">
                Download New Message
            </a>
            <a href="./assets/shortcuts/Recent%20Photos.shortcut" download class="rose-btn">
                Download Recent Photos
            </a>
            <a href="./assets/shortcuts/Open%20URLs.shortcut" download class="rose-btn">
                Download Open URLs
            </a>

            <p style="font-size: 1rem; opacity: 0.8; margin-top: 0.5rem; text-align: center;">
                Don't forget to create a local "on close" automation for returning to RoseOS app. <br>webapp://schrutesbeets.github.io/RoseOS/
            </p>

            <button class="rose-btn secondary" onclick="completeSetup()" style="margin-top: 1rem;">
                FINISH SETUP
            </button>
        </div>
    </dialog>



    <script>
        // State
        let mode = 'call'; // 'call' or 'text'
        let contacts = [];

        // Load contacts from Storage
        function loadContacts() {
            const stored = localStorage.getItem('roseos-contacts');
            if (stored) {
                contacts = JSON.parse(stored);
            } else {
                // Default / Example
                contacts = [];
            }
        }
        loadContacts();

        // --- CORE ACTIONS ---

        function handleAol() {
            // Simply navigate to the web version to prevent "invalid address" errors
            window.location.href = 'https://mail.aol.com';
        }

        function handleSearch() {
            const target = 'www.google.com';

            // Attempt to force opening in Chrome app on iOS
            window.location.href = `googlechromes://${target}`;

            // Fallback to internal web view or default browser if Chrome is missing
            setTimeout(() => {
                if (document.hidden) return; // Success, app presumably opened
                window.location.href = `https://${target}`;
            }, 1000);
        }

        function openPhotosLibrary() {
            // Run the Recent Photos shortcut
            window.location.href = 'shortcuts://run-shortcut?name=Recent%20Photos';
        }

        // --- MODAL MANIPULATION ---

        const callOptionsModal = document.getElementById('callOptionsModal');
        // const contactModal = document.getElementById('contactModal'); // Removed
        const dialerModal = document.getElementById('dialerModal');
        const addContactModal = document.getElementById('settingsModal'); // Keeps ID but var name changes

        function openCallModal() {
            callOptionsModal.showModal();
        }

        function closeCallOptions() {
            callOptionsModal.close();
        }

        function openDialerFromOptions() {
            closeCallOptions();
            dialerModal.showModal();
            document.getElementById('manualPhoneInput').focus();
        }

        /* Removed as contact modal is gone
        function openContactsFromOptions() {
            closeCallOptions();
            mode = 'call';
            document.getElementById('contactModalTitle').innerText = "Call Who?";
            renderContacts();
            contactModal.showModal();
        }

        function openTextModal() {
            mode = 'text';
            document.getElementById('contactModalTitle').innerText = "Text Who?";
            renderContacts();
            contactModal.showModal();
        }

        function closeContactModal() {
            contactModal.close();
        }
        */

        function openDialer() {
            // closeContactModal(); // Removed
            dialerModal.showModal();
            document.getElementById('manualPhoneInput').focus();
        }

        function closeDialerModal() {
            dialerModal.close();
        }

        function handleManualCall() {
            const num = document.getElementById('manualPhoneInput').value;
            if (!num) return;
            window.location.href = `tel:${num}`;
        }

        function openAddContact() {
            addContactModal.showModal();
        }

        function closeAddContact() {
            addContactModal.close();
        }

        // --- CONTACT LIST LOGIC ---

        // --- CONTACT LIST LOGIC (Removed) ---
        /*
        function renderContacts() {
            const container = document.getElementById('contactListContainer');
            container.innerHTML = '';

            if (contacts.length === 0) {
                container.innerHTML = '<div class="text-center" style="font-size: 1.2rem;">Click the button to search for a contact.</div>';

                // If empty, emphasize searching contacts
                const dialBtn = document.getElementById('dialerBtn');
                dialBtn.innerText = "FIND A CONTACT";
                dialBtn.onclick = () => {
                    window.location.href = 'shortcuts://run-shortcut?name=Open%20Contacts';
                };
                return;
            }

            // Reset dialer button to default if contacts exist
            const dialBtn = document.getElementById('dialerBtn');
            dialBtn.innerText = "DIAL NUMBER";
            dialBtn.onclick = openDialer;

            contacts.forEach(contact => {
                const btn = document.createElement('button');
                btn.className = 'rose-btn secondary';
                btn.innerText = contact.name;
                btn.style.marginBottom = '0.5rem';
                btn.onclick = () => performContactAction(contact);
                container.appendChild(btn);
            });
        }

        function performContactAction(contact) {
            if (mode === 'call') {
                window.location.href = `tel:${contact.number}`;
            } else {
                window.location.href = `sms:${contact.number}`;
            }
            closeContactModal();
        }
        */

        // --- THE VCARD HACK ---

        function saveContact(e) {
            e.preventDefault();
            const name = document.getElementById('newName').value.trim();
            const number = document.getElementById('newPhone').value.trim();

            if (!name || !number) return;

            // 1. Save to LocalStorage (for the App's UI)
            const newContact = { name, number, id: Date.now() };
            contacts.push(newContact);
            localStorage.setItem('roseos-contacts', JSON.stringify(contacts));

            // 2. Generate vCard (for the OS)
            const vCardData =
                `BEGIN:VCARD
VERSION:3.0
N:;${name};;;
FN:${name}
TEL;TYPE=CELL:${number}
END:VCARD`;

            const blob = new Blob([vCardData], { type: 'text/vcard;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            // Create invisible link and click it
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `${name}.vcf`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Cleanup
            document.getElementById('newName').value = '';
            document.getElementById('newPhone').value = '';
            closeAddContact();

            alert(`Saved! check your downloads to add ${name} to your phone contacts.`);
        }

        // --- WEATHER LOGIC ---

        function initWeather() {
            const widget = document.getElementById('weather-widget');
            const locEl = document.getElementById('weather-location');

            // Hide while searching
            widget.style.display = 'none';

            if (!navigator.geolocation) {
                console.log("Geo Not Supported");
                return;
            }

            // Simple loading state
            locEl.innerText = "Locating...";

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    fetchWeather(lat, lon);
                    fetchLocationName(lat, lon);
                },
                (err) => {
                    console.error(err);
                    locEl.innerText = "Location Off";
                }
            );
        }

        async function fetchLocationName(lat, lon) {
            try {
                // Using generic free reverse geocoding
                const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                const data = await res.json();
                const city = data.city || data.locality || data.principalSubdivision || "Unknown";
                const country = data.countryName || "";

                // Format: "Marikina, Philippines"
                let locString = city;
                // if (country) locString += `, ${country}`; // Keep it short for mobile

                document.getElementById('weather-location').innerText = locString;
            } catch (e) {
                console.error("Loc Name Error", e);
                // Fallback to coordinates
                document.getElementById('weather-location').innerText = `${lat.toFixed(1)}, ${lon.toFixed(1)}`;
            }
        }

        async function fetchWeather(lat, lon) {
            try {
                // Open-Meteo API with Daily for high/low
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.current) {
                    renderWeather(data);
                }
            } catch (e) {
                console.error("Weather error:", e);
                document.getElementById('weather-desc').innerText = "error";
            }
        }

        function renderWeather(data) {
            // Show widget
            document.getElementById('weather-widget').style.display = 'flex';

            const current = data.current;
            const daily = data.daily;

            const temp = Math.round(current.temperature_2m);
            const code = current.weather_code;

            // Render Current Temp
            document.getElementById('weather-temp').innerText = `${temp}°`;

            // Render High / Low
            // daily.temperature_2m_max[0] is today's max
            if (daily && daily.temperature_2m_max && daily.temperature_2m_min) {
                const max = Math.round(daily.temperature_2m_max[0]);
                const min = Math.round(daily.temperature_2m_min[0]);
                document.getElementById('weather-range').innerText = `${max}↑  ${min}↓`;
            }

            const { icon, label } = getWeatherAsset(code);
            document.getElementById('weather-icon').innerHTML = icon;
            document.getElementById('weather-desc').innerText = label;
        }

        function getWeatherAsset(code) {
            let iconSvg = '';
            let label = '';

            // MATERIAL ICON PATHS

            // Sunny / wb_sunny
            const svgSun = `<svg viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.8-1.41-1.41-1.79 1.8z"/></svg>`;

            // Cloud / cloud
            const svgCloud = `<svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>`;

            // Rain / rainy (Using a generic heavy rain look or standard)
            // This path is a mix, I will use a cleaner one
            const svgRain = `<svg viewBox="0 0 24 24"><path d="M4.11 14.84c-1.31-.59-2.11-1.92-2.11-3.34 0-2.21 1.79-4 4-4 .19 0 .37.02.55.05C7.54 4.88 10.07 3 13 3c3.31 0 6 2.69 6 6 0 .34-.04.68-.1 1a5.006 5.006 0 0 1 4.1 4.96c0 2.22-1.44 4.12-3.41 4.78l-1.09-3.26c.92-.31 1.5-1.12 1.5-2.02 0-1.29-1.06-2.36-2.35-2.4l-.65-.02V11.5c0-2.48-2.02-4.5-4.5-4.5-2.48 0-4.5 2.02-4.5 4.5v.69l-.66-.17c-1.15-.3-2.35.4-2.64 1.56-.25.99.27 2.03 1.18 2.45l-1.77 3.21zM7 15h2v6H7v-6zm4 2h2v6h-2v-6zm4-2h2v6h-2v-6z"/></svg>`;
            // Better Rain:
            const svgRainClean = `<svg viewBox="0 0 24 24"><path d="M12 4c-3.6 0-6.6 2.6-7.3 6H4c-2.2 0-4 1.8-4 4s1.8 4 4 4h1v3h2v-3h4v3h2v-3h4v3h2v-3h1c2.2 0 4-1.8 4-4s-1.8-4-4-4h-.7C21.6 6.6 18.6 4 15 4h-3z"/></svg>`; // This is more like 'cloudy with rain' in a blocky way. Let's use standard cloud + drops.
            // Actually, for simplicity and error avoidance, I will stick to the previous cloud path plus 3 drop paths if I can compose it, or just use the user's "rainy" request which implies a specific icon.
            // Let's use the one I found in search or a very standard one.
            // SVG Rain (Standard Material):
            const svgRainMat = `<svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM13 19h-2v-2h2v2zm0 4h-2v-2h2v2zm-4-4H7v-2h2v2zm0 4H7v-2h2v2zm8-4h-2v-2h2v2zm0 4h-2v-2h2v2z"/></svg>`;

            // Snow / ac_unit
            const svgSnow = `<svg viewBox="0 0 24 24"><path d="M22 11h-2V9h-2v2h-2.2c-.6-1.7-1.9-3-3.6-3.6V5h2V3h-2v2h-2V3h-2v2H6.6c-1.7.6-3 1.9-3.6 3.6H1V9h2v2H1v2h2v2h2.2c.6 1.7 1.9 3 3.6 3.6V21h-2v2h2v-2h2v2h2v-2h2.2c1.7-.6 3-1.9 3.6-3.6H21v-2h2v-2h-2v-2zm-10 4c-1.7 0-3-1.3-3-3s1.3-3 3-3 3 1.3 3 3-1.3 3-3 3z"/></svg>`;

            // Thunder / thunderstorm
            const svgThunder = `<svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM13.5 18l-3.5 6V19h-3l3.5-6v5h3z"/></svg>`;

            // Fog / Part Cloud (for general default)
            const svgPartlyCloudy = `<svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>`; // Reusing cloud for now as fog is tricky without dedicated path, but let's try a fog path
            // Fog / fog
            const svgFog = `<svg viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0 4h16v-2H4v2zm2-7h12v-2H6v2zm-2-5v2h16V11c0-2.97-2.16-5.43-5-5.91V5c0-2.76-2.24-5-5-5S5 2.24 5 5v.09C2.16 5.57 0 8.03 0 11z"/></svg>`; // This is 'fog' (weather-fog) approx

            if (code === 0) {
                iconSvg = svgSun;
                label = "Sunny";
            } else if ([1, 2, 3].includes(code)) {
                iconSvg = svgCloud;
                label = "Cloudy";
            } else if ([45, 48].includes(code)) {
                iconSvg = svgFog;
                label = "Foggy";
            } else if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) {
                iconSvg = svgRainMat;
                label = "Rain";
            } else if ([71, 73, 75, 77, 85, 86].includes(code)) {
                iconSvg = svgSnow;
                label = "Snow";
            } else if ([95, 96, 99].includes(code)) {
                iconSvg = svgThunder;
                label = "Thunder";
            } else {
                iconSvg = svgPartlyCloudy;
                label = "Cloudy";
            }

            return { icon: iconSvg, label };
        }

        // Auto-init on load
        window.addEventListener('load', () => {
            initWeather();
            initSecretReadme();
            initSetupWizard();
        });

        // --- SECRET INTERACTION ---

        function initSecretReadme() {
            const title = document.getElementById('app-title');
            let pressTimer;

            const startPress = (e) => {
                // Prevent context menu/selection on mobile
                pressTimer = window.setTimeout(() => {
                    document.getElementById('readmeModal').showModal();
                }, 1500);
            };

            const endPress = () => {
                clearTimeout(pressTimer);
            };

            // Touch events for mobile
            title.addEventListener('touchstart', startPress, { passive: true });
            title.addEventListener('touchend', endPress);
            title.addEventListener('touchcancel', endPress);

            // Mouse events for desktop testing
            title.addEventListener('mousedown', startPress);
            title.addEventListener('mouseup', endPress);
            title.addEventListener('mouseleave', endPress);

            // Prevent the context menu popup on long press
            title.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });
        }

        // --- SETUP WIZARD ---

        function initSetupWizard() {
            const hasSetup = localStorage.getItem('roseOSSetupComplete');
            if (!hasSetup) {
                // Small delay to ensure styles load or just for effect
                setTimeout(() => {
                    document.getElementById('setupWizardModal').showModal();
                }, 500);
            }
        }

        function completeSetup() {
            localStorage.setItem('roseOSSetupComplete', 'true');
            document.getElementById('setupWizardModal').close();
        }

    </script>
</body>

</html>